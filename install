#!/usr/bin/env zsh

set -euo pipefail

ZSH_COMPLETIONS="$HOME/.zfunc"
mkdir -p "$ZSH_COMPLETIONS"

# Function to generate completion if tool exists
generate_if_exists() {
	local tool=$1
	local command=$2
	local output="$ZSH_COMPLETIONS/_${tool}"

	if command -v $tool &>/dev/null; then
		echo "✓ Generating completion for $tool..."
		eval "$command" >"$output" 2>/dev/null && echo "  → $output" || echo "  ✗ Failed to generate"
	else
		echo "⊘ Skipping $tool (not installed)"
	fi
}

echo "Generating shell completions in $ZSH_COMPLETIONS"
echo

generate_if_exists "uv" "uv generate-shell-completion zsh"
generate_if_exists "uvx" "uvx --generate-shell-completion zsh"
generate_if_exists "ruff" "uvx ruff generate-shell-completion zsh"
generate_if_exists "sesh" "sesh completion zsh"
generate_if_exists "prek" "COMPLETE=zsh prek completion"

echo
echo "Rebuilding completion cache..."
autoload -Uz compinit && compinit

echo "Done! Restart your shell or run 'exec zsh' to load new completions."
