#!/usr/bin/env bash

# Git worktree manager - both interactive and CLI modes
# Usage:
#   worktree           # Interactive UI
#   worktree add <branch>    # Add worktree
#   worktree remove <path>   # Remove worktree

set -euo pipefail

usage() {
	cat <<EOF
Usage: worktree [COMMAND] [ARGS]

Commands:
    (no args)           Open interactive worktree manager
    add <branch>        Create new worktree for branch
    remove <path>       Remove worktree at path
    -h, --help          Show this help

Examples:
    worktree
    worktree add feature-login
    worktree remove /path/to/worktree
EOF
}

check_git_repo() {
	if ! git rev-parse --git-dir >/dev/null 2>&1; then
		return 1
	fi
	return 0
}

add_worktree() {
	local branch_name="$1"
	local repo_root
	repo_root=$(git worktree list | head -1 | awk '{print $1}')
	local worktree_path="$repo_root-features/$branch_name"

	if [[ -z "$branch_name" ]]; then
		echo "Error: Branch name cannot be empty"
		return 1
	fi

	if [[ -d "$worktree_path" ]]; then
		echo "Error: Worktree directory '$worktree_path' already exists"
		return 1
	fi

	# Try to create worktree with new branch first
	if git worktree add -b "$branch_name" "$worktree_path" >/dev/null 2>&1; then
		echo "Created worktree '$branch_name' at $worktree_path"
		return 0
	fi

	# If that failed, try with existing branch
	if git worktree add "$worktree_path" "$branch_name" >/dev/null 2>&1; then
		echo "Created worktree for existing branch '$branch_name' at $worktree_path"
		return 0
	else
		echo "Error: Failed to create worktree '$branch_name'"
		return 1
	fi
}

remove_worktree() {
	local worktree_path="$1"

	if [[ -z "$worktree_path" ]]; then
		echo "Error: Worktree path cannot be empty"
		return 1
	fi

	if git worktree remove -f "$worktree_path" 2>/dev/null; then
		echo "Removed worktree: $worktree_path"
		git delete-squashed >/dev/null 2>&1 || true
		tmux-clean >/dev/null 2>&1 || true
		return 0
	else
		echo "Error: Failed to remove worktree '$worktree_path'"
		return 1
	fi
}

interactive_mode() {
	if ! check_git_repo; then
		echo "Not a git repository"
		echo ""
		read -p "Press enter to close..."
		return 1
	fi

	local remove_cmd='
		[[ "$(pwd)" == {1}* ]] && cd "$(git worktree list | head -1 | awk '\''{print $1}'\'')";
		git worktree remove -f {1};
		git delete-squashed >/dev/null 2>&1 || true;
		tmux-clean >/dev/null 2>&1 || true;
		git worktree list
	'

	local selected
	selected=$(git worktree list | fzf \
		--ansi \
		--border-label 'ðŸŒ´ Worktrees ' \
		--header 'CTRL-X (remove) : CTRL-A (add) : ENTER (connect)' \
		--bind "ctrl-x:reload($remove_cmd)" \
		--bind 'ctrl-a:reload(worktree add {q} >/dev/null 2>&1; git worktree list)' \
		--preview "
			echo -e '\033[1;36mðŸ“ Worktree:\033[0m {1}'
			echo
			echo -e '\033[1;33mðŸ“Š Status:\033[0m'
			git -C {1} -c color.status=always status --short --branch 2>/dev/null
			echo
			echo -e '\033[1;35mðŸ“œ Recent Commits:\033[0m'
			git -C {1} log --oneline --graph --date=short --color=always --pretty='format:%C(auto)%cd %h%d %s' -10 2>/dev/null
		") || return 0

	if [[ -n "$selected" ]]; then
		local worktree_path
		worktree_path=$(echo "$selected" | awk '{print $1}')
		sesh connect "$worktree_path"
	fi
}

main() {
	case "${1:-}" in
	-h | --help)
		usage
		exit 0
		;;
	add)
		if ! check_git_repo; then
			echo "Error: Not a git repository"
			exit 1
		fi
		add_worktree "${2:-}"
		;;
	remove)
		if ! check_git_repo; then
			echo "Error: Not a git repository"
			exit 1
		fi
		remove_worktree "${2:-}"
		;;
	"")
		interactive_mode
		;;
	*)
		echo "Error: Unknown command '$1'"
		echo ""
		usage
		exit 1
		;;
	esac
}

main "$@"
