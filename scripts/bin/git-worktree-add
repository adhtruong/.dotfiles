#!/usr/bin/env bash
# Create a new git worktree relative to repository root

set -euo pipefail

function main() {
	local branch_name="$1"
	local repo_root
	repo_root=$(git worktree list | head -1 | awk '{print $1}')
	local worktree_path="$repo_root-features/$branch_name"

	if [[ -z "$branch_name" ]]; then
		echo "Branch name cannot be empty"
		return 1
	fi

	# Check if worktree path already exists
	if [[ -d "$worktree_path" ]]; then
		echo "Worktree directory '$worktree_path' already exists"
		return 1
	fi

	# Try to create worktree with new branch first
	git worktree add -b "$branch_name" "$worktree_path" >/dev/null 2>&1
	if [[ $? -eq 0 ]]; then
		echo "Created worktree '$branch_name' at $worktree_path"
		return 0
	fi

	# If that failed, try with existing branch
	git worktree add "$worktree_path" "$branch_name" >/dev/null 2>&1
	if [[ $? -eq 0 ]]; then
		echo "Created worktree for existing branch '$branch_name' at $worktree_path"
	else
		echo "Failed to create worktree '$branch_name'"
		return 1
	fi
}

main "$@"
